<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8"></meta>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"></meta>
<title>Pok√©mon GO Gym Badge Map</title>

<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
    integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
    crossorigin=""
></link>
<script
    src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""
></script>

<style>

html, body, #map {
    height: 100%;
    width: 100%;
    padding: 0;
    margin: 0;
}

.gymName {
    font-weight: bold;
    line-height: 200%;
}

.badge {
    display: inline-block;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    border: 3px solid black;
    cursor: pointer;
}

.badge:hover {
    border: 3px solid blue;
}

.badgeHidden {
    height: 16px;
    width: 16px;
    margin: 2px;
}

.input {
    display: inline-block;
    border: 10px;
    cursor: pointer;
    background-color: white;
    font-family: sans-serif;
    font-size: 20px;
    line-height: 30px;
    color: blue;
}

.input:hover {
    text-decoration: underline;
}

input[type=text] {
    font-size: 30px;
    width: 50vw;
}

input[type=checkbox] {
    display: none;
}

</style>

</head>
<body>

<div id="map"></div>

<div id="menuTemplate">
<input
    type="button"
    class="input"
    value="Load gyms from gomap.eu"
    onclick="loadGymsFromGoMap()"
><br>
<input
    type="button"
    class="input"
    value="Import gyms from file"
    onclick="loadGymsFromFile()"
><br>
<input
    type="button"
    class="input"
    value="Export gyms to file"
    onclick="saveGymsToFile()"
>
</div>

<div id="searchTemplate">
<input
    type="text"
    placeholder="Gym Name"
    id="gymSearch"
    list="gymList"
    onclick="select()"
    oninput="openGymPopup()"
>
<datalist id="gymList">
</datalist>
</div>

<script>

const SETTINGS_TITLE = 'gymBadgeMap';
const BADGE_COLORS = {
    'gold': 'gold',
    'silver': 'silver',
    'bronze': 'orangeRed',
    'visited': 'lightGreen',
    'none': 'green'
};

const BREMEN = [53.07, 8.79];  // latitude, longitude
const VIEW = BREMEN;
const ZOOM = 12;

const NUMBER_OF_POKEMON = 400;  // there are more pokemon in total, but less in the game

// keep requests to gomap.eu at a minimum
const RELOAD_INTERVAL = 3000;  // milliseconds
const RELOAD_MIN_DISTANCE = 5000;  // meters

var gyms = {};

var baseLayers = {};
var overlays = {};
var layerGroups = [];
Object.keys(BADGE_COLORS).forEach(function(badge) {
    var layerGroup = L.layerGroup();
    overlays[badge] = layerGroup;
    layerGroups.push(layerGroup);
});

var map = L.map('map', {
    zoomControl: false,
    layers: layerGroups
}).setView(VIEW, ZOOM);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

L.control.zoom({position: 'bottomleft'}).addTo(map);

var userLocation;
function onLocationFound(e) {
    if (userLocation) {
        map.removeLayer(userLocation);
    }
    userLocation = L.marker(e.latlng).addTo(map);
}

function onLocationError(e) {
    console.log(e);
    alert(e.message);
}

map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);

var locateControl = L.control({position: 'bottomleft'});
locateControl.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'leaflet-bar');
    var a = L.DomUtil.create('a', 'leaflet-control-zoom-in leaflet-interactive', this._div);
    a.innerHTML = '&#x1f4cd;';
    a.addEventListener('click', function() {
        map.locate({setView: true, maxZoom: ZOOM});
    });
    return this._div;
};
locateControl.addTo(map);

L.control.layers(baseLayers, overlays, {position: 'topleft'}).addTo(map);
var layersControl = document.getElementsByClassName('leaflet-control-layers-overlays')[0];
for (var i = 0; i < layersControl.children.length; i++) {
    var option = layersControl.children[i];
    option.style = 'display: inline-block;';
    var optionLabel = option.children[0].children[1];
    var badgeColor = optionLabel.innerHTML.trim();
    option.children[0].removeChild(optionLabel);
    var badge = L.DomUtil.create('span');
    L.DomUtil.addClass(badge, 'badge');
    badge.style = 'background-color: ' + BADGE_COLORS[badgeColor] + ';';
    option.appendChild(badge);
    option.onclick = function() {
        var badge = this.children[1];
        if (this.children[0].children[0].checked) {
            L.DomUtil.removeClass(badge, 'badgeHidden');
        } else {
            L.DomUtil.addClass(badge, 'badgeHidden');
        }
    }
}
var menu = L.DomUtil.create('div', 'menuControl');
var template = document.getElementById('menuTemplate');
menu.innerHTML = template.innerHTML;
document.body.removeChild(template);
layersControl.appendChild(menu);

var searchControl = L.control({position: 'topright'});
searchControl.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'searchControl');
    var template = document.getElementById('searchTemplate');
    document.body.removeChild(template);
    this._div.innerHTML = template.innerHTML;
    return this._div;
};
searchControl.addTo(map);

function Gym(coordinates, id, name, badge) {
    this._coordinates = coordinates;
    this._id = '' + id;
    this._name = name || '[no name]';
    this._badge = badge || 'none';
    this._marker = L.circleMarker(coordinates, {
        color: 'black',
        fillColor: BADGE_COLORS[badge],
        fillOpacity: 1,
        radius: 10
    });
    var popup = '<div class="gymName">' + name + '</div>';
    Object.keys(BADGE_COLORS).forEach(function(badge) {
        popup += '<input type="button" class="badge" style="background-color: ' + BADGE_COLORS[badge] + ';" title="' + badge + '" onclick="setGymBadge(\'' + id + '\', \'' + badge + '\')">';
    });
    this._marker.bindPopup(popup);
    overlays[badge].addLayer(this._marker);
}

function setGymBadge(id, badge, noSave) {
    Object.values(gyms).forEach(function(gym) {
        if (gym._id === id) {
            overlays[gym._badge].removeLayer(gym._marker);
            overlays[badge].addLayer(gym._marker);
            gym._marker.setStyle({fillColor: BADGE_COLORS[badge]});
            gym._badge = badge;
        }
    });
    map.closePopup();
    if (!noSave) {
        saveGymsToLocalStorage();
    }
}

function updateAutoCompleteList() {
    var gymListHTML = '';
    Object.values(gyms).forEach(function(gym) {
        gymListHTML += '<option value="' + gym._name.replace(/"/g, '&quot;') + '"/>';
    });
    document.getElementById('gymList').innerHTML = gymListHTML;
}

function openGymPopup() {
    Object.values(gyms).forEach(function(gym) {
        var gymSearch = document.getElementById('gymSearch');
        if (gym._name === gymSearch.value) {
            gymSearch.blur();
            gym._marker.openPopup();
            map.setView(gym._coordinates, map.getZoom());
        }
    });
}

function createJson() {
    var gymsArray = [];
    Object.values(gyms).forEach(function(gym) {
        if (gym._badge !== 'none') {
            gymsArray.push(JSON.parse(JSON.stringify(gym, [
                '_coordinates',
                '_id',
                '_name',
                '_badge'
            ])));
        }
    });
    return JSON.stringify({gyms: gymsArray});
}

function createGyms(json) {
    var jsonGyms = JSON.parse(json).gyms;
    jsonGyms.forEach(function(gym) {
        var coordinates = gym._coordinates || [gym.latitude, gym.longitude];
        var id = gym._id || gym.gym_id;
        var name = gym._name || gym.name;
        var badge = gym._badge || 'none';
        if (gyms[id]) {
            gyms[id]._coordinates = coordinates;
            gyms[id]._name = name;
            if (badge !== 'none') {
                setGymBadge(id, badge, true);
            }
        } else {
            gyms[id] = new Gym(coordinates, id, name, badge);
        }
    });
    saveGymsToLocalStorage();
    updateAutoCompleteList();
}

function loadGymsFromGoMap() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            createGyms(this.responseText);
        }
    };
    var bounds = map.getBounds();
    var n = bounds._northEast.lat;
    var e = bounds._northEast.lng;
    var s = bounds._southWest.lat;
    var w = bounds._southWest.lng;
    var url = 'https://mapdata2.gomap.eu/mnew.php?&mid=0&gid=0'
        + '&n=' + n
        + '&e=' + e
        + '&s=' + s
        + '&w=' + w
        + '&ex=%5B';  // [
    // exclude all pokemon, we just need gyms
    for (var i = 0; i < NUMBER_OF_POKEMON; i++) {
        url += i + '%2C';  // ,
    }
    url += '%5D';  // ]
    xhttp.open('GET', url, true);
    xhttp.send();
}

function loadGymsFromLocalStorage() {
    try {
        createGyms(localStorage.getItem(SETTINGS_TITLE));
    } catch (error) {
        console.log('localStorage is not available');
    }
}

function saveGymsToLocalStorage() {
    if (!Object.keys(gyms).length) {
        return;
    }
    try {
        localStorage.setItem(SETTINGS_TITLE, createJson());
    } catch (error) {
        console.log('localStorage is not available');
    }
}

function loadGymsFromFile() {
    const INPUT_ID = 'files';
    var files = document.getElementById(INPUT_ID);
    if (files) {
        document.body.removeChild(files);
    }
    var fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = INPUT_ID;
    fileInput.style = 'display: none;';
    fileInput.onchange = readGymsFromFile;
    document.body.appendChild(fileInput);
    fileInput.click();
}

function readGymsFromFile() {
    var files = document.getElementById('files').files;
    if (!files.length) {
        return;
    }
    var reader = new FileReader();
    reader.onloadend = function(event) {
        if (reader.readyState == FileReader.DONE) {
            createGyms(reader.result);
        }
    };
    reader.readAsText(files[0]);
}

function saveGymsToFile() {
    const LINK_ID = 'link';
    var link = document.getElementById(LINK_ID);
    if (link) {
        document.body.removeChild(link);
    }
    link = document.createElement('a');
    var file = new Blob([createJson()], {type: 'application/json'});
    var url = window.URL.createObjectURL(file);
    link.href = url;
    link.style = 'display: none;';
    link.download = 'gyms.json';
    link.id = LINK_ID;
    document.body.appendChild(link);
    link.click();
}

// init
loadGymsFromLocalStorage();
loadGymsFromGoMap();
document.getElementById('gymSearch').focus();

/*var previousMapCenter = map.getCenter();
setInterval(function() {
    var currentMapCenter = map.getCenter();
    if (map.distance(currentMapCenter, previousMapCenter) >= RELOAD_MIN_DISTANCE) {
        loadGymsFromGoMap();
        previousMapCenter = currentMapCenter;
    }
}, RELOAD_INTERVAL);*/

</script>

</body>
</html>

